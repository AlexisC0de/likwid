<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>LIKWID: LIKWID API in a C/C++ application</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">LIKWID
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">LIKWID API in a C/C++ application </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * =======================================================================================</span>
<span class="comment"> *</span>
<span class="comment"> *      Filename:  C-likwidAPI.c</span>
<span class="comment"> *</span>
<span class="comment"> *      Description:  Example how to use the LIKWID API in C/C++ applications</span>
<span class="comment"> *</span>
<span class="comment"> *      Version:   &lt;VERSION&gt;</span>
<span class="comment"> *      Released:  &lt;DATE&gt;</span>
<span class="comment"> *</span>
<span class="comment"> *      Author:  Thomas Roehl (tr), thomas.roehl@googlemail.com</span>
<span class="comment"> *      Project:  likwid</span>
<span class="comment"> *</span>
<span class="comment"> *      Copyright (C) 2015 RRZE, University Erlangen-Nuremberg</span>
<span class="comment"> *</span>
<span class="comment"> *      This program is free software: you can redistribute it and/or modify it under</span>
<span class="comment"> *      the terms of the GNU General Public License as published by the Free Software</span>
<span class="comment"> *      Foundation, either version 3 of the License, or (at your option) any later</span>
<span class="comment"> *      version.</span>
<span class="comment"> *</span>
<span class="comment"> *      This program is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<span class="comment"> *      WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A</span>
<span class="comment"> *      PARTICULAR PURPOSE.  See the GNU General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> *      You should have received a copy of the GNU General Public License along with</span>
<span class="comment"> *      this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="comment"> *</span>
<span class="comment"> * =======================================================================================</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>

<span class="preprocessor">#include &lt;likwid.h&gt;</span>

<span class="preprocessor">#define EVENTSET &quot;INSTR_RETIRED_ANY:FIXC0&quot;</span>
<span class="preprocessor"></span>

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])
{
    <span class="keywordtype">int</span> i;
    <span class="keywordtype">int</span> err;
    <span class="keywordtype">int</span>* cpus;
    <span class="keywordtype">int</span> gid;
    <span class="keywordtype">double</span> result = 0.0;

    <span class="comment">// Load the topology module and print some values.</span>
    err = <a class="code" href="group__CPUTopology.html#gad07900ac8cf9242b13e4fd3560da91f0" title="Initialize topology information.">topology_init</a>();
    <span class="keywordflow">if</span> (err &lt; 0)
    {
        printf(<span class="stringliteral">&quot;Failed to initialize LIKWID&#39;s topology module\n&quot;</span>);
        <span class="keywordflow">return</span> 1;
    }
    <span class="comment">// CpuInfo_t contains global information like name, CPU family, ...</span>
    <a class="code" href="structCpuInfo.html" title="Structure with general CPU information.">CpuInfo_t</a> info = <a class="code" href="group__CPUTopology.html#gac8f052a1af35be7813d5ff2b16dcde92" title="Retrieve CPU information of the current machine.">get_cpuInfo</a>();
    <span class="comment">// CpuTopology_t contains information about the topology of the CPUs.</span>
    <a class="code" href="structCpuTopology.html" title="Structure describing the topology of the HW threads in the system.">CpuTopology_t</a> topo = <a class="code" href="group__CPUTopology.html#ga532e1427d24e4d58920a64523fc3ce59" title="Retrieve CPU topology of the current machine.">get_cpuTopology</a>();
    printf(<span class="stringliteral">&quot;Likwid example on a %s with %d CPUs\n&quot;</span>, info-&gt;<a class="code" href="structCpuInfo.html#a543077bafdaaa87a293df1dcb1e9f21d" title="Name of the CPU as identified by LIKWID.">name</a>, topo-&gt;<a class="code" href="structCpuTopology.html#a9171d1006dc1d1b5f0f6e71ec799c345" title="Amount of HW threads in the system and length of threadPool.">numHWThreads</a>);

    cpus = malloc(topo-&gt;<a class="code" href="structCpuTopology.html#a9171d1006dc1d1b5f0f6e71ec799c345" title="Amount of HW threads in the system and length of threadPool.">numHWThreads</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
    <span class="keywordflow">if</span> (!cpus)
        <span class="keywordflow">return</span> 1;

    <span class="keywordflow">for</span> (i=0;i&lt;topo-&gt;<a class="code" href="structCpuTopology.html#a9171d1006dc1d1b5f0f6e71ec799c345" title="Amount of HW threads in the system and length of threadPool.">numHWThreads</a>;i++)
    {
        cpus[i] = topo-&gt;<a class="code" href="structCpuTopology.html#ad3617418aabe270261f1e11bd6666882" title="List of all HW thread descriptions.">threadPool</a>[i].<a class="code" href="structHWThread.html#a4ade3a332e66c6f273344bd770f66b0d" title="ID of HW thread retrieved through the Advanced Programmable Interrupt Controller.">apicId</a>;
    }

    <span class="comment">// Must be called before perfmon_init() but only if you want to use another</span>
    <span class="comment">// access mode as the pre-configured one. For direct access (0) you have to</span>
    <span class="comment">// be root.</span>
    <span class="comment">//accessClient_setaccessmode(0);</span>

    <span class="comment">// Initialize the perfmon module.</span>
    err = <a class="code" href="group__PerfMon.html#ga237e009bbea642f9570e84cef4236f20" title="Initialize performance monitoring facility.">perfmon_init</a>(topo-&gt;<a class="code" href="structCpuTopology.html#a9171d1006dc1d1b5f0f6e71ec799c345" title="Amount of HW threads in the system and length of threadPool.">numHWThreads</a>, cpus);
    <span class="keywordflow">if</span> (err &lt; 0)
    {
        printf(<span class="stringliteral">&quot;Failed to initialize LIKWID&#39;s performance monitoring module\n&quot;</span>);
        <a class="code" href="group__CPUTopology.html#gaed026f614f67b7f2b0dca197175434a9" title="Destroy topology structures CpuInfo_t and CpuTopology_t.">topology_finalize</a>();
        <span class="keywordflow">return</span> 1;
    }

    <span class="comment">// Add eventset string to the perfmon module.</span>
    gid = <a class="code" href="group__PerfMon.html#gae26e2a4aeff3f53166f2e9890477b229" title="Add an event string to LIKWID.">perfmon_addEventSet</a>(EVENTSET);
    <span class="keywordflow">if</span> (gid &lt; 0)
    {
        printf(<span class="stringliteral">&quot;Failed to add event string %s to LIKWID&#39;s performance monitoring module\n&quot;</span>, EVENTSET);
        <a class="code" href="group__PerfMon.html#ga7581063dc5b23b46812e04c633cc754f" title="Close the perfomance monitoring facility of LIKWID.">perfmon_finalize</a>();
        <a class="code" href="group__CPUTopology.html#gaed026f614f67b7f2b0dca197175434a9" title="Destroy topology structures CpuInfo_t and CpuTopology_t.">topology_finalize</a>();
        <span class="keywordflow">return</span> 1;
    }

    <span class="comment">// Setup the eventset identified by group ID (gid).</span>
    err = <a class="code" href="group__PerfMon.html#ga904e2d33a1b548d4f3cb0c13ebe867f9" title="Setup all performance monitoring counters of an eventSet.">perfmon_setupCounters</a>(gid);
    <span class="keywordflow">if</span> (err &lt; 0)
    {
        printf(<span class="stringliteral">&quot;Failed to setup group %d in LIKWID&#39;s performance monitoring module\n&quot;</span>, gid);
        <a class="code" href="group__PerfMon.html#ga7581063dc5b23b46812e04c633cc754f" title="Close the perfomance monitoring facility of LIKWID.">perfmon_finalize</a>();
        <a class="code" href="group__CPUTopology.html#gaed026f614f67b7f2b0dca197175434a9" title="Destroy topology structures CpuInfo_t and CpuTopology_t.">topology_finalize</a>();
        <span class="keywordflow">return</span> 1;
    }
    <span class="comment">// Start all counters in the previously set up event set.</span>
    err = <a class="code" href="group__PerfMon.html#ga1e8aa42c02693b72b060b319590e634c" title="Start performance monitoring counters.">perfmon_startCounters</a>();
    <span class="keywordflow">if</span> (err &lt; 0)
    {
        printf(<span class="stringliteral">&quot;Failed to start counters for group %d for thread %d\n&quot;</span>,gid, (-1*err)-1);
        <a class="code" href="group__PerfMon.html#ga7581063dc5b23b46812e04c633cc754f" title="Close the perfomance monitoring facility of LIKWID.">perfmon_finalize</a>();
        <a class="code" href="group__CPUTopology.html#gaed026f614f67b7f2b0dca197175434a9" title="Destroy topology structures CpuInfo_t and CpuTopology_t.">topology_finalize</a>();
        <span class="keywordflow">return</span> 1;
    }
    <span class="comment">// Perform something</span>
    sleep(2);
    <span class="comment">// Stop all counters in the previously started event set.</span>
    err = <a class="code" href="group__PerfMon.html#ga6b17d0e4c590ff30d84f54847773ff44" title="Stop performance monitoring counters.">perfmon_stopCounters</a>();
    <span class="keywordflow">if</span> (err &lt; 0)
    {
        printf(<span class="stringliteral">&quot;Failed to stop counters for group %d for thread %d\n&quot;</span>,gid, (-1*err)-1);
        <a class="code" href="group__PerfMon.html#ga7581063dc5b23b46812e04c633cc754f" title="Close the perfomance monitoring facility of LIKWID.">perfmon_finalize</a>();
        <a class="code" href="group__CPUTopology.html#gaed026f614f67b7f2b0dca197175434a9" title="Destroy topology structures CpuInfo_t and CpuTopology_t.">topology_finalize</a>();
        <span class="keywordflow">return</span> 1;
    }


    <span class="comment">// Print the result of every thread/CPU.</span>
    <span class="keywordflow">for</span> (i = 0;i &lt; topo-&gt;<a class="code" href="structCpuTopology.html#a9171d1006dc1d1b5f0f6e71ec799c345" title="Amount of HW threads in the system and length of threadPool.">numHWThreads</a>; i++)
    {
        result = <a class="code" href="group__PerfMon.html#gac752281cecee656015768ac7f4328054" title="Get the results of the specified group, counter and thread.">perfmon_getResult</a>(gid, 0, i);
        printf(<span class="stringliteral">&quot;Measurement result for event set %s at CPU %d: %f\n&quot;</span>, EVENTSET, cpus[i], result);
    }

    <span class="comment">// Uninitialize the perfmon module.</span>
    <a class="code" href="group__PerfMon.html#ga7581063dc5b23b46812e04c633cc754f" title="Close the perfomance monitoring facility of LIKWID.">perfmon_finalize</a>();
    <span class="comment">// Uninitialize the topology module.</span>
    <a class="code" href="group__CPUTopology.html#gaed026f614f67b7f2b0dca197175434a9" title="Destroy topology structures CpuInfo_t and CpuTopology_t.">topology_finalize</a>();
    <span class="keywordflow">return</span> 0;
}
</pre></div> </div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Mon Oct 5 2015 11:18:01 for LIKWID by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
